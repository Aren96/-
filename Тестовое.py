import pandas as pd
# Функция для загрузки данных
def load_data(file_path):
    return pd.read_csv(file_path)

# Функция для фильтрации данных по коду товара и периоду
def filter_data(df, код_товара, год, месяц):
    return df[(df['Код ОКПД-2'] == код_товара) &
              (df['Год'] == год) &
              (df['Месяц'] == месяц)]

# Функция для группировки данных по округам и суммирования значений
def group_and_sum(df):
    return df.groupby('Округ', dropna=True)['Значение'].sum().reset_index()

# Функция для расчета дельты в процентах
def calculate_delta(df1, df2):
    merged = pd.merge(df1, df2, on='Округ', suffixes=('_период1', '_период2'), how='outer')
    merged.fillna(0, inplace=True)  # Заменяем NaN на 0 для расчетов
    merged['∆ (%)'] = ((merged['Значение_период2'] - merged['Значение_период1']) / merged['Значение_период1']) * 100
    merged['∆ (%)'].replace([float('inf'), -float('inf')], 0, inplace=True)  # Заменяем бесконечности на 0
    return merged

# Функция для добавления итоговой строки
def add_total_row(df):
    сумма_период1 = df['Значение_период1'].sum()
    сумма_период2 = df['Значение_период2'].sum()
    дельта_сумма = ((сумма_период2 - сумма_период1) / сумма_период1) * 100 if сумма_период1 != 0 else 0
    итоговая_строка = pd.DataFrame({'Округ': ['Все округа'],
                                    'Значение_период1': [сумма_период1],
                                    'Значение_период2': [сумма_период2],
                                    '∆ (%)': [дельта_сумма]})
    return pd.concat([итоговая_строка, df], ignore_index=True)

# Функция для сортировки данных по убыванию дельты
def sort_data(df):
    return df.sort_values(by='∆ (%)', ascending=False)

# Основная функция для выполнения задачи
def main():
    # Загрузка данных
    df = load_data('Испытательное.csv')

    # Запрос кода товара у пользователя
    код_товара = input("Введите код товара (ОКПД-2): ")

    # Запрос двух периодов (год и месяц) у пользователя
    год1 = int(input("Введите первый год: "))
    месяц1 = int(input("Введите первый месяц: "))
    год2 = int(input("Введите второй год: "))
    месяц2 = int(input("Введите второй месяц: "))

    # Фильтрация данных по введенному коду товара и периодам
    период1 = filter_data(df, код_товара, год1, месяц1)
    период2 = filter_data(df, код_товара, год2, месяц2)

    # Группировка и суммирование данных по округам
    группировка_период1 = group_and_sum(период1)
    группировка_период2 = group_and_sum(период2)

    # Расчет дельты и объединение данных
    объединенные_данные = calculate_delta(группировка_период1, группировка_период2)

    # Добавление итоговой строки
    объединенные_данные = add_total_row(объединенные_данные)

    # Сортировка данных по убыванию дельты
    объединенные_данные = sort_data(объединенные_данные)

    # Вывод результата
    print(f"Результаты для кода товара: {код_товара}")
    print(объединенные_данные)

# Запуск основной функции
if __name__ == "__main__":
    while True:
        main()
        продолжить = input("Хотите продолжить? (да/нет): ").strip().lower()
        if продолжить != 'да':
            break